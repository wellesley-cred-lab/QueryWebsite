<DOCTYPE html>
    <html>
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width"> 
        <title>Comparator</title>
		<script src="node_modules/jquery/dist/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> 
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/brython@3.8.10/brython.min.js"> </script> 
        <script src="https://cdn.jsdelivr.net/npm/brython@3.8.10/brython_stdlib.js"> </script> -->
        <script src="app.js"></script>
        <link rel="stylesheet" href="../main.css">
    </head>
    <body>
        <div>
            <p id=query>Query</p>    
        </div>

        <div>
            <span id=date1 style="width: 50%; float:left;">Date 1</span>
            <span id=date2 style="width: 50%; float:left;">Date 2</span>
        </div>


        <iframe id="iframeDate1" name="myIframe" frameborder="5" width="480" height="600"></iframe>
        <iframe id="iframeDate2" name="myIframe" frameborder="5" width="480" height="600"></iframe>

        <!-- <div>
            <p id="differenceOrganic">Difference</p> 
            <p id="differenceNonOrganic">Difference</p> 
        </div> -->
        <div id="table" style="display: inline-table; vertical-align: top;"></div>
        <!-- <div id="moveupdownTable" style="display: inline-table;"></div> -->
        <div id="new"></div>
        <script>
            var params = {};
            location.search.slice(1).split("&").forEach(function(pair) {
            pair = pair.split("=");
            params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            });
            selectedQuery = params['param1'].replaceAll("%20"," ");
            previousDate = params['param3'];
            currentDate = params['param2'];
            console.log(params);
            console.log(selectedQuery);
            console.log(previousDate);
            console.log(currentDate);


            let script = document.createElement('script');
            jsonName = "serp-scraper-get-difference/changeswithVar/"+selectedQuery+"_changebetween_"+previousDate+"_and_"+currentDate+"_addVar.json";
            script.src=jsonName;
            script.onload = function(){
                var changes = [];  //delete later
                var moveUp = [];
                var moveDown = [];
                var appear = [];
                var disappear = [];
                for(var key in data) {
                    var value = data[key];
                    if (key == 'organic'){
                        //console.log(key);
                        //console.log(value);
                        for(var domainKey in value) {
                            //console.log(domainKey);
                            var organicChange = value[domainKey];
                            //console.log(organicChange);
                            if(organicChange['change_type']=='unchanged'){
                                var s = "The organic domain "+ domainKey +" is unchanged.";
                                //console.log(s);
                            }
                            else if(organicChange['change_type']=='move'){
                                var s = "The organic domain "+ domainKey +" moved ";
                                console.log(organicChange['change']);
                                if(organicChange['change']<0){
                                    s+="down ";
                                    s+=-1*organicChange['change'];
                                    s+=" positions.";
                                    moveDown.push({"domain":domainKey.substring(8), "pos1":organicChange['pos1'], "pos2":organicChange['pos2']});
                                }
                                else{
                                    s+="up ";
                                    s+=organicChange['change'];
                                    s+=" positions.";
                                    moveUp.push({"domain":domainKey.substring(8), "pos1":organicChange['pos1'], "pos2":organicChange['pos2']});
                                }
                                changes.push(s);
                                //console.log(s);
                            }
                            else{
                                var s = "The organic domain "+ domainKey +" " + organicChange['change_type']+"ed.";
                                changes.push(s);
                                //console.log(s);
                                if(organicChange['change_type']=='appear'){
                                    appear.push(domainKey.substring(8));
                                }
                                else{
                                    disappear.push(domainKey.substring(8));
                                }
                            }
                        }
                    }
                    else{
                        if (value['change_type'] == 'unchanged'){
                            var s = "The component "+ key+" is unchanged.";
                            //console.log(s);
                        }
                        else{
                            var s = "The component "+key+" has "+value['change_type']+"ed.";
                            changes.push(s);
                            //console.log(s);
                            if(value['change_type']=='appear'){
                                    appear.push(key);
                                }
                                else{
                                    disappear.push(key);
                                }
                        }
                    }
                    }
                    
                    console.log(changes);
                    console.log("appear");
                    console.log(appear);
                    console.log("disappear");
                    console.log(disappear);
                    console.log('moveUp');
                    console.log(moveUp);
                    console.log('moveDown');
                    console.log(moveDown);

                    //Add table for the components/organic result domain that appeared
                    var $appearTable = $('<table style=\"border: 1px solid;\"/>');
                    console.log(appear.length);
                    $appearTable.append( '<tr><td style=\"font-weight: bold;\">' + "Appeared" + '</td><td style=\"border: 1px solid; font-weight: bold;\">' + "Count: " + appear.length + '</td></tr>' );
                    for(var item in appear){
                        console.log(appear[item]);
                        $appearTable.append( '<tr><td>' + " " + '</td><td style=\"border: 1px solid;\">' + appear[item] + '</td></tr>' );
                    }
                    $('#table').append($appearTable);

                    //Add table for the components/organic result domain that disappeared
                    var $disappearTable = $('<table style=\"border: 1px solid;\"/>');
                    console.log(disappear.length);
                    $disappearTable.append( '<tr><td style=\"font-weight: bold;\">' + "Disappeared" + '</td><td style=\"border: 1px solid; font-weight: bold;\">' + "Count: " + disappear.length + '</td></tr>' );
                    for(var item in disappear){
                        console.log(disappear[item]);
                        $disappearTable.append( '<tr><td>' + " " + '</td><td style=\"border: 1px solid;\">' + disappear[item] + '</td></tr>' );
                    }
                    $('#table').append($disappearTable);

                    var $upTable = $('<table style=\"border: 1px solid;\"/>');
                    $upTable.append( '<tr><td style=\"font-weight: bold;\">' + "Moved Up" + '</td><td style=\"border: 1px solid; font-weight: bold;\">' + "Count: " + moveUp.length + '</td><td style=\"border: 1px solid; font-weight: bold;\">'+"Position Change"+ '</td></tr>');
                    for(var item in moveUp){
                        console.log(moveUp[item]);
                        $upTable.append( '<tr><td>' + " " + '</td><td style=\"border: 1px solid;\">' + moveUp[item]['domain'] + '</td><td style=\"border: 1px solid;\">'+moveUp[item]['pos1']+ "->" + moveUp[item]['pos2']+ '</td></tr>' );
                    }
                    $('#table').append($upTable);

                    var $downTable = $('<table style=\"border: 1px solid;\"/>');
                    $downTable.append( '<tr><td style=\"font-weight: bold;\">' + "Moved Down" + '</td><td style=\"border: 1px solid; font-weight: bold;\">' + "Count: " + moveDown.length + '</td><td style=\"border: 1px solid; font-weight: bold;\">'+"Position Change"+ '</td></tr>' );
                    for(var item in moveDown){
                        console.log(moveDown[item]);
                        $downTable.append( '<tr><td>' + " " + '</td><td style=\"border: 1px solid;\">' + moveDown[item]['domain'] + '</td><td style=\"border: 1px solid;\">'+moveDown[item]['pos1']+ "->" + moveDown[item]['pos2']+ '</td</tr>' );
                    }
                    $('#table').append($downTable);


                    // var $table = $('<table/>');
                    // for(var change in changes){
                    //     console.log(changes[change]);
                    //     $table.append( '<tr><td>' + changes[change] + '</td></tr>' );
                    // }
                    // $('#differenceTable').append($table);

                    // $(document).ready(function(){
                    //     $('#differenceTable').css({"border":"1px solid"});
                    // })
            }
            
            var element=document.getElementById("new");
            element.appendChild(script);
        </script>
        
        
        <script>
            $(document).ready(function(){
                $('#query').text("Query: "+selectedQuery);
                $('#date1').text("Previous Date: "+previousDate);
                $('#date2').text("Current Date: "+currentDate);
                filename1 = 'SERP_Collection/'+previousDate+"/"+selectedQuery+".html";
                filename2 = 'SERP_Collection/'+currentDate+"/"+selectedQuery+".html";
                //filename1 = 'SERP_Collection_modified/'+previousDate+"/"+selectedQuery+".html";
                //filename2 = 'SERP_Collection_modified/'+currentDate+"/"+selectedQuery+".html";
                $(document).ready(function(){
                    console.log(filename1);
                    $('#iframeDate1').attr('src', filename1);
                    $('#iframeDate2').attr('src', filename2);

                });


                });
            /*$(document).ready(function(){
                jsonName = "serp-scraper-get-difference/changes/"+selectedQuery+"_changebetween_"+previousDate+"_and_"+currentDate+".json"
                $.getJSON(jsonName, function(data){
                    console.log(data);
                    for (const [key, value] of Object.entries(data)) {
                        if (key!="organic"){
                            console.log(key+"Not organic");
                            $('#difference').text(key+": "+value);
                        }
                    }
                })
            });*/
                
        </script>
        
        <!-- <script type="text/javascript" src='data.json'></script> -->
        <!-- <script>console.log(data.one)</script> -->  
    </body>